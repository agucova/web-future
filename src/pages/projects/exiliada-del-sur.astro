---
// Standalone page - no layout
import { getImage } from "astro:assets";

// Import all place images
import losLagosImg from "../../assets/exiliada-del-sur/places/los-lagos.jpg";
import parralImg from "../../assets/exiliada-del-sur/places/parral.jpg";
import buinImg from "../../assets/exiliada-del-sur/places/buin.jpg";
import sanVicenteImg from "../../assets/exiliada-del-sur/places/san-vicente.jpg";
import curacautinImg from "../../assets/exiliada-del-sur/places/curacautin.jpg";
import maitencilloImg from "../../assets/exiliada-del-sur/places/maitencillo.jpg";
import pelequenImg from "../../assets/exiliada-del-sur/places/pelequen.jpg";
import perquilauquenImg from "../../assets/exiliada-del-sur/places/perquilauquen.jpg";
import sanRosendoImg from "../../assets/exiliada-del-sur/places/san-rosendo.jpg";
import quiriquinaImg from "../../assets/exiliada-del-sur/places/quiriquina.jpg";
import temucoImg from "../../assets/exiliada-del-sur/places/temuco.jpg";
import calbucoImg from "../../assets/exiliada-del-sur/places/calbuco.jpg";
import chacabucoImg from "../../assets/exiliada-del-sur/places/chacabuco.jpg";
import granerosImg from "../../assets/exiliada-del-sur/places/graneros.jpg";
import sanSebastianImg from "../../assets/exiliada-del-sur/places/san-sebastian.jpg";
import chillanImg from "../../assets/exiliada-del-sur/places/chillan.jpg";
import cabreroImg from "../../assets/exiliada-del-sur/places/cabrero.jpg";
import itataImg from "../../assets/exiliada-del-sur/places/itata.jpg";
import nacimientoImg from "../../assets/exiliada-del-sur/places/nacimiento.jpg";
import rinihueImg from "../../assets/exiliada-del-sur/places/rinihue.jpg";

// Generate optimized images (webp, sized for display)
const optimizedImages = {
    "los-lagos": await getImage({
        src: losLagosImg,
        width: 400,
        format: "webp",
    }),
    parral: await getImage({ src: parralImg, width: 400, format: "webp" }),
    buin: await getImage({ src: buinImg, width: 400, format: "webp" }),
    "san-vicente": await getImage({
        src: sanVicenteImg,
        width: 400,
        format: "webp",
    }),
    curacautin: await getImage({
        src: curacautinImg,
        width: 400,
        format: "webp",
    }),
    maitencillo: await getImage({
        src: maitencilloImg,
        width: 400,
        format: "webp",
    }),
    pelequen: await getImage({ src: pelequenImg, width: 400, format: "webp" }),
    perquilauquen: await getImage({
        src: perquilauquenImg,
        width: 400,
        format: "webp",
    }),
    "san-rosendo": await getImage({
        src: sanRosendoImg,
        width: 400,
        format: "webp",
    }),
    quiriquina: await getImage({
        src: quiriquinaImg,
        width: 400,
        format: "webp",
    }),
    temuco: await getImage({ src: temucoImg, width: 400, format: "webp" }),
    calbuco: await getImage({ src: calbucoImg, width: 400, format: "webp" }),
    chacabuco: await getImage({
        src: chacabucoImg,
        width: 400,
        format: "webp",
    }),
    graneros: await getImage({ src: granerosImg, width: 400, format: "webp" }),
    "san-sebastian": await getImage({
        src: sanSebastianImg,
        width: 400,
        format: "webp",
    }),
    chillan: await getImage({ src: chillanImg, width: 400, format: "webp" }),
    cabrero: await getImage({ src: cabreroImg, width: 400, format: "webp" }),
    itata: await getImage({ src: itataImg, width: 400, format: "webp" }),
    nacimiento: await getImage({
        src: nacimientoImg,
        width: 400,
        format: "webp",
    }),
    rinihue: await getImage({ src: rinihueImg, width: 400, format: "webp" }),
};

// Create a map of place keys to optimized image URLs for the client-side script
const imageUrls = Object.fromEntries(
    Object.entries(optimizedImages).map(([key, img]) => [key, img.src]),
);
---

<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Exiliada del Sur — Violeta Parra</title>
        <!-- Preload first two images (los-lagos and parral appear first in the song) -->
        <link
            rel="preload"
            as="image"
            href={optimizedImages["los-lagos"].src}
        />
        <link rel="preload" as="image" href={optimizedImages["parral"].src} />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,600;1,8..60,400&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <div class="main-container">
            <!-- STICKY HEADER: único contenedor sticky en mobile -->
            <header class="sticky-header">
                <div class="poem-header">
                    <h1>La Exiliada del Sur</h1>
                    <span class="subtitle">Violeta Parra</span>
                    <span class="year">(c. 1958)</span>
                    <span class="info-icon"
                        >i
                        <span class="tooltip">
                            Décima n.° 58 del libro <em
                                >Décimas: Autobiografía en verso</em
                            >, publicado póstumamente en 1970. Musicalizada por
                            Patricio Manns en 1971. Popularizada por
                            Inti-Illimani y Los Bunkers.
                        </span>
                    </span>
                </div>

                <div class="audio-player-row">
                    <div class="audio-player" id="audioPlayer">
                        <audio id="audioElement" preload="metadata">
                            <source
                                src="/exiliada-del-sur/exiliada_del_sur_inti_illimani.opus"
                                type="audio/ogg"
                            />
                        </audio>

                        <button
                            class="play-btn"
                            id="playBtn"
                            aria-label="Reproducir"
                        >
                            <span class="play-icon">▶</span>
                            <span class="pause-icon">❚❚</span>
                        </button>

                        <div class="player-info">
                            <div class="track-title">La Exiliada del Sur</div>
                            <div class="track-artist">Inti Illimani</div>
                        </div>

                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar" id="progressBar"></div>
                            <div class="progress-handle" id="progressHandle">
                            </div>
                        </div>

                        <div class="time-display">
                            <span id="currentTime">0:00</span>
                            <span class="time-separator">/</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>
                </div>

                <div class="map-panel">
                    <div id="map"></div>
                </div>

                <!-- Mobile place bar (compact info below map) -->
                <div class="mobile-place-bar" id="mobilePlaceBar">
                    <div class="place-summary">
                        <span class="place-name" id="mobileBarName"
                            >Toca un lugar</span
                        >
                        <span class="fragment" id="mobileBarFragment"></span>
                    </div>
                </div>
            </header>

            <!-- SIDEBAR: solo visible en desktop -->
            <aside class="sidebar-info">
                <div class="place-info-content">
                    <div class="info-default" id="infoDefault">
                        <p>
                            Haz clic en cualquier lugar del poema para ver su
                            ubicación y conocer su historia.
                        </p>
                    </div>

                    <div class="place-info" id="placeInfo">
                        <div class="place-image-container">
                            <img id="placeImage" src="" alt="" />
                        </div>
                        <div class="place-text">
                            <div class="place-header">
                                <div class="place-title-row">
                                    <h3 id="placeName"></h3>
                                    <span class="fragment" id="placeFragment"
                                    ></span>
                                </div>
                                <span class="coords" id="placeCoords"></span>
                            </div>
                            <div class="description" id="placeDescription">
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- CONTENIDO: scrolleable -->
            <main class="poem-main">
                <div class="poem-content">
                    <div class="stanza" data-stanza="1">
                        <span class="stanza-number">I</span>
                        <div class="verse-line">
                            Un ojo dejé en <a
                                class="place-link"
                                data-place="los-lagos">Los Lagos</a>
                        </div>
                        <div class="verse-line">por un descuido casual</div>
                        <div class="verse-line">
                            El otro quedó en <a
                                class="place-link"
                                data-place="parral">Parral</a>
                        </div>
                        <div class="verse-line">en un boliche de tragos</div>
                        <div class="verse-line">Recuerdo que mucho estrago</div>
                        <div class="verse-line">de niña vio el alma mía</div>
                        <div class="verse-line">
                            Miserias y <span
                                class="word-hint"
                                data-word="alevosias">alevosías</span>
                        </div>
                        <div class="verse-line">anudan mis pensamientos</div>
                        <div class="verse-line">
                            Entre las aguas y el viento
                        </div>
                        <div class="verse-line">me pierdo en la lejanía</div>
                    </div>

                    <div class="stanza" data-stanza="2">
                        <span class="stanza-number">II</span>
                        <div class="verse-line">
                            Mi brazo derecho en <a
                                class="place-link"
                                data-place="buin">Buín</a>
                        </div>
                        <div class="verse-line">quedó señores oyentes</div>
                        <div class="verse-line">
                            El otro por <a
                                class="place-link"
                                data-place="san-vicente">San Vicente</a>
                        </div>
                        <div class="verse-line">quedó no sé con qué fin</div>
                        <div class="verse-line">
                            Mi pecho en <a
                                class="place-link"
                                data-place="curacautin">Curacautín</a>
                        </div>
                        <div class="verse-line">lo veo en un jardincillo</div>
                        <div class="verse-line">
                            Mis manos, en <a
                                class="place-link"
                                data-place="maitencillo">Maitencillo</a>
                        </div>
                        <div class="verse-line">
                            saludan en <a
                                class="place-link"
                                data-place="pelequen">Pelequén</a>
                        </div>
                        <div class="verse-line">
                            Mi blusa en <a
                                class="place-link"
                                data-place="perquilauquen">Perquilauquén</a>
                        </div>
                        <div class="verse-line">recoge unos pececillos</div>
                    </div>

                    <div class="stanza" data-stanza="3">
                        <span class="stanza-number">III</span>
                        <div class="verse-line">
                            Se me enredó en <a
                                class="place-link"
                                data-place="san-rosendo">San Rosendo</a>
                        </div>
                        <div class="verse-line">
                            un pie al cruzar una esquina
                        </div>
                        <div class="verse-line">
                            El otro en la <a
                                class="place-link"
                                data-place="quiriquina">Quiriquina</a>
                        </div>
                        <div class="verse-line">se me hunde mares adentro</div>
                        <div class="verse-line">Mi corazón descontento</div>
                        <div class="verse-line">
                            latió con pena en <a
                                class="place-link"
                                data-place="temuco">Temuco</a>
                        </div>
                        <div class="verse-line">
                            Y me ha llorado en <a
                                class="place-link"
                                data-place="calbuco">Calbuco</a>
                        </div>
                        <div class="verse-line">de frío por una escarcha</div>
                        <div class="verse-line">Voy, enderezo mi marcha</div>
                        <div class="verse-line">
                            a la cuesta de <a
                                class="place-link"
                                data-place="chacabuco">Chacabuco</a>
                        </div>
                    </div>

                    <div class="stanza" data-stanza="4">
                        <span class="stanza-number">IV</span>
                        <div class="verse-line">
                            Mis nervios dejo en <a
                                class="place-link"
                                data-place="graneros">Graneros</a>
                        </div>
                        <div class="verse-line">
                            la sangre en <a
                                class="place-link"
                                data-place="san-sebastian">San Sebastián</a>
                        </div>
                        <div class="verse-line">
                            Y en la ciudad de <a
                                class="place-link"
                                data-place="chillan">Chillán</a>
                        </div>
                        <div class="verse-line">la calma me bajó a cero</div>
                        <div class="verse-line">
                            Mi riñonada en <a
                                class="place-link"
                                data-place="cabrero">Cabrero</a>
                        </div>
                        <div class="verse-line">destruye una caminata</div>
                        <div class="verse-line">
                            Y en una calle de <a
                                class="place-link"
                                data-place="itata">Itata</a>
                        </div>
                        <div class="verse-line">
                            se me rompió el instrumento
                        </div>
                        <div class="verse-line">
                            Y <span class="word-hint" data-word="endilgo"
                                >endilgó</span
                            > pa' <a class="place-link" data-place="nacimiento"
                                >Nacimiento</a>
                        </div>
                        <div class="verse-line">una mañana de plata</div>
                    </div>

                    <div class="stanza" data-stanza="5">
                        <span class="stanza-number">V</span>
                        <div class="verse-line">
                            Desembarcando en <a
                                class="place-link"
                                data-place="rinihue">Riñihue</a>
                        </div>
                        <div class="verse-line">se vio la Violeta Parra</div>
                        <div class="verse-line">Sin cuerdas en la guitarra</div>
                        <div class="verse-line">
                            sin hojas en el <span
                                class="word-hint"
                                data-word="coligue">coligüe</span>
                        </div>
                        <div class="verse-line">
                            Una banda de <span
                                class="word-hint"
                                data-word="chirigues">chirigües</span>
                        </div>
                        <div class="verse-line">le vino a dar un concierto</div>
                        <div class="verse-line">
                            Desembarcando en <a
                                class="place-link"
                                data-place="rinihue">Riñihue</a>
                        </div>
                        <div class="verse-line">se vio a la Violeta Parra</div>
                    </div>
                </div>

                <div class="poem-footer">
                    Décima n.° 58, <em>Décimas</em> (c. 1958, pub. 1970) · Música:
                    Patricio Manns
                </div>
            </main>
        </div>

        <!-- Bottom Sheet para mobile (lugares) -->
        <div class="bottom-sheet-overlay" id="bottomSheetOverlay"></div>
        <div class="bottom-sheet" id="bottomSheet">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">
                <div class="place-title-row">
                    <h3 id="mobilePlaceName"></h3>
                    <span class="fragment" id="mobilePlaceFragment"></span>
                </div>
                <span class="coords" id="mobilePlaceCoords"></span>
            </div>
            <div class="description" id="mobilePlaceDescription"></div>
            <div
                class="bottom-sheet-image-container"
                id="bottomSheetImageContainer"
            >
                <img id="bottomSheetImage" src="" alt="" />
            </div>
        </div>

        <!-- Bottom Sheet para mobile (definiciones) -->
        <div class="bottom-sheet-overlay" id="wordBottomSheetOverlay"></div>
        <div class="bottom-sheet word-bottom-sheet" id="wordBottomSheet">
            <div class="bottom-sheet-handle"></div>
            <div class="word-sheet-content">
                <div
                    class="word-sheet-image-container"
                    id="wordSheetImageContainer"
                >
                    <img id="wordSheetImage" src="" alt="" />
                </div>
                <div class="word-sheet-text">
                    <div class="word-sheet-header">
                        <span class="word-sheet-title" id="wordSheetTitle"
                        ></span>
                        <span class="word-sheet-origin" id="wordSheetOrigin"
                        ></span>
                    </div>
                    <div class="word-sheet-definition" id="wordSheetDefinition">
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Sheet para mobile (info del poema) -->
        <div class="bottom-sheet-overlay" id="infoBottomSheetOverlay"></div>
        <div class="bottom-sheet info-bottom-sheet" id="infoBottomSheet">
            <div class="bottom-sheet-handle"></div>
            <div class="info-sheet-header">
                <h3>Sobre este poema</h3>
            </div>
            <div class="info-sheet-content">
                Décima n.° 58 del libro <em>Décimas: Autobiografía en verso</em
                >, publicado póstumamente en 1970. Musicalizada por Patricio
                Manns en 1971. Popularizada por Inti-Illimani y Los Bunkers.
            </div>
        </div>

        <script is:inline define:vars={{ imageUrls }}>
            window.placeImageUrls = imageUrls;
        </script>
        <script is:inline>
            var places = {
                "los-lagos": {
                    name: "Los Lagos (Región)",
                    coords: [-41.47, -72.94],
                    fragment: "Un ojo",
                    verse: "Un ojo dejé en Los Lagos / por un descuido casual",
                    description:
                        "Los Lagos, el distrito de los lagos de Chile, es un paisaje de aguas esmeralda acunado por volcanes nevados, donde antiguos bosques de alerce encuentran las costas brumosas de Chiloé. En los años 50 y 60, Violeta Parra viajó por estos territorios del sur recopilando canciones populares, proverbios y tradiciones de comunidades rurales. Dejar un ojo aquí es dejar parte de la propia visión en una tierra donde la memoria habita en el agua y la madera.",
                    image: window.placeImageUrls["los-lagos"],
                },
                parral: {
                    name: "Parral",
                    coords: [-36.14, -71.83],
                    fragment: "El otro ojo",
                    verse: "El otro quedó en Parral / en un boliche de tragos",
                    description:
                        "Parral, cuna de Pablo Neruda en el corazón vinícola de Chile, es un pueblo empapado de verso y vino. El «boliche de tragos» evoca la vida precaria e itinerante de los artistas populares — Violeta y sus hermanos cantaban en tabernas y cantinas desde niños, ganando monedas para sobrevivir. En este pueblo polvoriento del Valle Central donde las viñas trepan hacia los Andes, poesía y penuria siempre compartieron la misma mesa.",
                    image: window.placeImageUrls["parral"],
                },
                buin: {
                    name: "Buín",
                    coords: [-33.73, -70.74],
                    fragment: "Brazo derecho",
                    verse: "Mi brazo derecho en Buín / quedó señores oyentes",
                    description:
                        "Buín se asienta en el valle vinícola del Maipo, 35 kilómetros al sur de Santiago — tierra agrícola fértil donde viñedos y huertos han definido la vida por generaciones. El «señores oyentes» de Violeta hace eco del trato directo de la radio, ese espacio íntimo donde una cantora habla a oyentes invisibles como si fueran amigos reunidos cerca.",
                    image: window.placeImageUrls["buin"],
                },
                "san-vicente": {
                    name: "San Vicente de Tagua Tagua",
                    coords: [-34.44, -71.08],
                    fragment: "Brazo izquierdo",
                    verse: "El otro por San Vicente / quedó no sé con qué fin",
                    description:
                        "San Vicente de Tagua Tagua — «tagua» es el nombre de la gallareta, ave acuática que habitaba el antiguo lago — se levanta sobre el lecho de un lago pleistocénico donde mastodontes vagaron y los primeros cazadores del continente dejaron su huella hace más de 12.000 años. Este tranquilo pueblo agrícola en O'Higgins, rodeado de huertos de duraznos y ciruelas, preserva la memoria profunda de aguas drenadas hace milenios y una cultura huasa arraigada en el suelo fértil. Un lugar donde algo puede quedar atrás y ser recordado por milenios.",
                    image: window.placeImageUrls["san-vicente"],
                },
                curacautin: {
                    name: "Curacautín",
                    coords: [-38.43, -71.89],
                    fragment: "Pecho",
                    verse: "Mi pecho en Curacautín / lo veo en un jardincillo",
                    description:
                        "Curacautín — cuyo nombre en mapudungun evoca «piedra negra» o «lugar de reunión de piedras» — yace en el corazón del Wallmapu mapuche, puerta de entrada a los antiguos bosques de araucarias y los volcanes humeantes de la Araucanía. Fundado como fuerte militar en 1882 durante la ocupación chilena del territorio mapuche, el pueblo custodia el umbral entre dos grandes paisajes volcánicos — Lonquimay y Llaima. Fue en estas tierras del sur donde Violeta Parra viajó en los años 50, recopilando ülkantun (cantos tradicionales) que darían forma a su obra más profunda.",
                    image: window.placeImageUrls["curacautin"],
                },
                maitencillo: {
                    name: "Maitencillo",
                    coords: [-32.65, -71.44],
                    fragment: "Manos",
                    verse: "Mis manos, en Maitencillo / saludan en Pelequén",
                    description:
                        "Un pueblo costero azotado por el viento, aferrado al litoral central de Chile, donde el Pacífico frío golpea contra rocas volcánicas y arena rubia. Desde estas orillas al norte de Valparaíso, se puede alzar la mano hacia la cordillera e imaginarla alcanzando a través de la costa hacia los valles del interior — hacia lugares como Pelequén, a horas de distancia en el corazón de Chile. En el verso de Violeta, este gesto se convierte en imagen de conexión imposible: la exiliada al borde del mar, saludando hacia un hogar que no puede tocar.",
                    image: window.placeImageUrls["maitencillo"],
                },
                pelequen: {
                    name: "Pelequén",
                    coords: [-34.47, -70.92],
                    fragment: "Manos (saludan)",
                    verse: "Mis manos, en Maitencillo / saludan en Pelequén",
                    description:
                        "Un nudo ferroviario en el Valle Central de Chile donde la línea principal norte-sur alguna vez se ramificaba hacia el oeste, hacia los lagos de Tagua Tagua. La Estación de Pelequén, inaugurada en 1862, era el tipo de lugar que Violeta conocía bien de sus años cantando en trenes y viajando a lo largo de Chile para recopilar canciones populares — un andén de llegadas y partidas, de manos que se agitan en despedida.",
                    image: window.placeImageUrls["pelequen"],
                },
                perquilauquen: {
                    name: "Perquilauquén",
                    coords: [-35.83, -71.82],
                    fragment: "Blusa",
                    verse: "Mi blusa en Perquilauquén / recoge unos pececillos",
                    description:
                        "Un río que serpentea por los campos de Ñuble, cerca de donde Violeta Parra pasó su infancia. Su nombre en mapudungun evoca plumas y aguas — «perguin» (plumaje) y «lauquen» (mar o lago grande). En la visión de exilio de la cantora, una blusa flota sola por la corriente, atrapando pececillos — un gesto tierno e imposible, como un fantasma ejecutando los rituales del hogar.",
                    image: window.placeImageUrls["perquilauquen"],
                },
                "san-rosendo": {
                    name: "San Rosendo",
                    coords: [-37.26, -72.72],
                    fragment: "Un pie",
                    verse: "Se me enredó en San Rosendo / un pie al cruzar una esquina",
                    description:
                        "San Rosendo fue la frontera ferroviaria de Chile, el empalme desde donde partían todos los viajes hacia el sur — un pueblo de llegadas, transbordos y partidas suspendidas. Fundada en 1873, en su apogeo decenas de trenes cruzaban diariamente este nudo ferroviario; ahora la antigua estación permanece curtida junto a su reemplazo moderno, monumento al impulso interrumpido. Tropezar aquí, con el pie atrapado en una esquina, es quedar atrapada por el peso de caminos que ya no corren.",
                    image: window.placeImageUrls["san-rosendo"],
                },
                quiriquina: {
                    name: "Isla Quiriquina",
                    coords: [-36.63, -73.06],
                    fragment: "El otro pie",
                    verse: "El otro en la Quiriquina / se me hunde mares adentro",
                    description:
                        "La Isla Quiriquina guarda la entrada a la Bahía de Concepción, una pequeña isla naval frente a Talcahuano donde la Armada de Chile ha entrenado marineros desde principios del siglo XX. En la geografía del desplazamiento de Violeta, es el único fragmento entregado por completo al océano — un pie que se hunde «mares adentro», tragado por el Pacífico. Su nombre en mapudungun evoca bandadas de zorzales — «kirke» (zorzal), «kina» (muchos) — aves que alguna vez llenaron sus acantilados, aunque sus aguas han presenciado conquistas españolas y capítulos más oscuros por venir.",
                    image: window.placeImageUrls["quiriquina"],
                },
                temuco: {
                    name: "Temuco",
                    coords: [-38.74, -72.6],
                    fragment: "Corazón",
                    verse: "Mi corazón descontento / latió con pena en Temuco",
                    description:
                        "Capital de la Araucanía y corazón del territorio mapuche ancestral, Temuco fue fundada como fuerte militar en 1881 durante la violenta ocupación chilena de las tierras indígenas. El nombre de la ciudad proviene del mapudungun, significando «agua de temu», por los arrayanes rojos que crecen junto a sus vertientes. Cuando el corazón de Violeta late «con pena» aquí, reconoce siglos de despojo y resistencia — un duelo que ella conoció íntimamente a través de su trabajo documentando los cantos tradicionales mapuche en el sur.",
                    image: window.placeImageUrls["temuco"],
                },
                calbuco: {
                    name: "Calbuco",
                    coords: [-41.77, -73.13],
                    fragment: "Corazón (llora)",
                    verse: "Y me ha llorado en Calbuco / de frío por una escarcha",
                    description:
                        "Calbuco — «agua azul» en mapudungun — marca el punto más austral de la fragmentación de Violeta en el poema. Este antiguo pueblo pesquero en Los Lagos se aferra al borde de un archipiélago frío, donde iglesias de madera y casas coloridas enfrentan los canales grises del Pacífico. Aquí, en el umbral de Chiloé y el sur profundo, la escarcha muerde más fuerte y la lluvia nunca cede del todo — un término adecuado para el lamento de una exiliada.",
                    image: window.placeImageUrls["calbuco"],
                },
                chacabuco: {
                    name: "Cuesta de Chacabuco",
                    coords: [-32.97, -70.71],
                    fragment: "Marcha",
                    verse: "Voy, enderezo mi marcha / a la cuesta de Chacabuco",
                    description:
                        "Un paso cordillerano azotado por el viento al norte de Santiago, donde los Andes comienzan a ceder. Aquí, en febrero de 1817, O'Higgins y San Martín derrotaron a los realistas españoles, y la historia oficial de Chile se forjó entre cargas de caballería y humo de cañón. Violeta endereza su marcha hacia este monumento del triunfo nacional — pero llega no como conquistadora, solo como fragmentos que regresan del exilio, del sur, hacia un centro que quizás no la reconozca.",
                    image: window.placeImageUrls["chacabuco"],
                },
                graneros: {
                    name: "Graneros",
                    coords: [-34.07, -70.73],
                    fragment: "Nervios",
                    verse: "Mis nervios dejo en Graneros",
                    description:
                        "Graneros — «los graneros» — donde Chile almacena la cosecha de su Valle Central. En esta comuna agrícola rodeada de campos de trigo y viñedos, Violeta deja sus nervios: los filamentos crudos y expuestos del sentir que conectan cuerpo con tierra. La estrofa más visceral encuentra su hogar en un lugar construido para guardar lo que nos sustenta.",
                    image: window.placeImageUrls["graneros"],
                },
                "san-sebastian": {
                    name: "San Sebastián (Yumbel)",
                    coords: [-37.08, -72.57],
                    fragment: "Sangre",
                    verse: "La sangre en San Sebastián",
                    description:
                        "Yumbel, históricamente llamado San Sebastián de Yumbel — el sitio de peregrinación más sagrado del sur de Chile. El santo atravesado por flechas, su imagen de madera de cedro contrabandeada a través de guerras y escondida en campos. Violeta deja su sangre en el santuario del mártir, en las tierras fronterizas disputadas donde ella nació.",
                    image: window.placeImageUrls["san-sebastian"],
                },
                chillan: {
                    name: "Chillán",
                    coords: [-36.61, -72.1],
                    fragment: "Calma",
                    verse: "Y en la ciudad de Chillán / la calma me bajó a cero",
                    description:
                        "La capital provincial de Ñuble, Chillán fue la ciudad que Violeta Parra llamó hogar de niña, donde primero aprendió a tocar guitarra y componer. En 1939, un terremoto a medianoche arrasó casi por completo la ciudad, matando a decenas de miles. Que su calma «baje a cero» aquí sugiere la traición más profunda: ni siquiera el lugar que la formó puede darle refugio.",
                    image: window.placeImageUrls["chillan"],
                },
                cabrero: {
                    name: "Cabrero",
                    coords: [-37.04, -72.4],
                    fragment: "Riñones",
                    verse: "Mi riñonada en Cabrero / destruye una caminata",
                    description:
                        "Cabrero, un pueblo ferroviario nacido a fines del siglo XIX cuando las vías del sur abrieron el interior de Chile a la colonización. Aquí, donde campos de trigo se extienden hacia el río Biobío y familias inmigrantes alguna vez se reunían alrededor de la estación, el cuerpo falla a mitad del viaje — los riñones que «destruyen una caminata» hablando del agotamiento de quienes viajaron lejos, solo para encontrar el camino súbitamente imposible de continuar.",
                    image: window.placeImageUrls["cabrero"],
                },
                itata: {
                    name: "Valle del Itata",
                    coords: [-36.28, -72.54],
                    fragment: "Instrumento",
                    verse: "Y en una calle de Itata / se me rompió el instrumento",
                    description:
                        "El Valle del Itata, cuyo nombre en mapudungun significa abundante pastizal, alberga los viñedos más antiguos de Chile — cepas de País y Moscatel plantadas por misioneros españoles en 1551, aún cultivadas hoy sin riego a la manera antigua. Aquí, donde el río Itata alguna vez marcaba el límite entre los pueblos mapuche y picunche, el instrumento de Violeta se rompe en una calle sin nombre. Ya sea la guitarra o su propio cuerpo lo que cedió, ella continúa — como las viejas viñas continúan, cultivadas en seco y sin injertar, extrayendo sustento de fuentes más profundas.",
                    image: window.placeImageUrls["itata"],
                },
                nacimiento: {
                    name: "Nacimiento",
                    coords: [-37.5, -72.67],
                    fragment: "Guitarra (va)",
                    verse: "Y endilgó pa' Nacimiento / una mañana de plata",
                    description:
                        "Nacimiento — «Natividad» — se levanta donde el Vergara encuentra el Biobío, un pueblo nacido como fuerte español en Nochebuena de 1603, en el mismo borde del territorio mapuche. Su nombre significa «nacimiento» — y así la guitarra rota, abandonada por su dueña, se dirige hacia un lugar de comienzos, cruzando hacia las tierras ancestrales que resistieron la conquista por tres siglos. En el verso de Violeta, este viaje ocurre en una «mañana de plata», como si el instrumento se disolviera en mito, vagando hacia los bosques brumosos del sur donde la memoria y la resistencia aún viven en la tierra misma.",
                    image: window.placeImageUrls["nacimiento"],
                },
                rinihue: {
                    name: "Lago Riñihue",
                    coords: [-39.83, -72.32],
                    fragment: "Violeta entera",
                    verse: "Desembarcando en Riñihue / se vio la Violeta Parra",
                    description:
                        "Lago glaciar en Los Ríos, el último de la cadena de los Siete Lagos. Su nombre en mapudungun significa «lugar de coligües» — rëngi (caña de bambú), hue (lugar) — conectando con el verso donde Violeta llega «sin hojas en el coligüe». En 1960, tras el terremoto más grande jamás registrado, derrumbes bloquearon su desagüe y el agua comenzó a subir, amenazando con borrar Valdivia del mapa. En el Riñihuazo, cientos de hombres cavaron con palas contra el tiempo — la tierra herida, resistiendo. Aquí desembarca Violeta al final: sin guitarra, sin hojas en el coligüe, despojada de todo salvo su nombre. Los chirigües — pájaros humildes del sur — le ofrecen el último concierto.",
                    image: window.placeImageUrls["rinihue"],
                },
            };

            // Word definitions for tooltips
            var wordDefinitions = {
                alevosias: {
                    word: "alevosías",
                    origin: "(del latín «a levare»)",
                    definition:
                        "Traiciones o engaños cometidos con premeditación y cautela. En el contexto del poema, evoca las injusticias y maltratos sufridos durante una infancia de pobreza.",
                },
                endilgo: {
                    word: "endilgó",
                    origin: "(Chile, coloquial)",
                    definition:
                        "Dirigirse o encaminarse hacia un lugar. Del español antiguo «endilgar», enderezar.",
                },
                coligue: {
                    word: "coligüe",
                    origin: "(Chusquea culeou)",
                    definition:
                        "Bambú nativo de los bosques templados de Chile y Argentina. Sus cañas huecas se usan en artesanía, construcción rural y como tutores de plantas.",
                },
                chirigues: {
                    word: "chirigüe",
                    origin: "(Sicalis luteola)",
                    definition:
                        "Pequeño pájaro cantor de los pastizales sudamericanos. De plumaje amarillo verdoso con estrías pardas, habita desde Colombia hasta Tierra del Fuego.",
                    image: "/exiliada-del-sur/chirique.jpg",
                },
            };

            // Place timings in milliseconds - [timestamp, placeKey, stanzaNumber]
            var placeTimings = [
                // Estrofa 1
                [28000, "los-lagos", 1],
                [33000, "parral", 1],
                // Estrofa 2
                [54000, "buin", 2],
                [58000, "san-vicente", 2],
                [64000, "curacautin", 2],
                [70000, "maitencillo", 2],
                [73000, "pelequen", 2],
                [76000, "perquilauquen", 2],
                // Estrofa 3
                [90000, "san-rosendo", 3],
                [96000, "quiriquina", 3],
                [104000, "temuco", 3],
                [108000, "calbuco", 3],
                [115000, "chacabuco", 3],
                // Estrofa 4
                [118000, "graneros", 4],
                [120000, "san-sebastian", 4],
                [123000, "chillan", 4],
                [129000, "cabrero", 4],
                [134000, "itata", 4],
                [140000, "nacimiento", 4],
                // Estrofa 5
                [150000, "rinihue", 5],
                [181000, "rinihue", 5],
                [191000, "rinihue", 5],
            ];

            var map = null;
            var markers = {};
            var currentPlaceIndex = -1;
            var currentStanza = null;
            var isUserInteracting = false;

            // HTML5 Audio Player
            var audio = document.getElementById("audioElement");
            var playBtn = document.getElementById("playBtn");
            var progressContainer =
                document.getElementById("progressContainer");
            var progressBar = document.getElementById("progressBar");
            var progressHandle = document.getElementById("progressHandle");
            var currentTimeEl = document.getElementById("currentTime");
            var durationEl = document.getElementById("duration");
            var audioPlayer = document.getElementById("audioPlayer");
            var isDragging = false;

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                var mins = Math.floor(seconds / 60);
                var secs = Math.floor(seconds % 60);
                return mins + ":" + (secs < 10 ? "0" : "") + secs;
            }

            audio.addEventListener("loadedmetadata", function () {
                durationEl.textContent = formatTime(audio.duration);
            });

            audio.addEventListener("timeupdate", function () {
                if (!isDragging) {
                    var percent = (audio.currentTime / audio.duration) * 100;
                    progressBar.style.width = percent + "%";
                    progressHandle.style.left = percent + "%";
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                    updatePlaybackPosition(audio.currentTime * 1000);
                }
            });

            audio.addEventListener("play", function () {
                audioPlayer.classList.add("playing");
            });

            audio.addEventListener("pause", function () {
                audioPlayer.classList.remove("playing");
            });

            audio.addEventListener("ended", function () {
                audioPlayer.classList.remove("playing");
                progressBar.style.width = "0%";
                progressHandle.style.left = "0%";
                currentTimeEl.textContent = "0:00";
            });

            playBtn.addEventListener("click", function () {
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                }
            });

            function seekToPosition(e) {
                var rect = progressContainer.getBoundingClientRect();
                var percent = Math.max(
                    0,
                    Math.min(1, (e.clientX - rect.left) / rect.width),
                );
                audio.currentTime = percent * audio.duration;
                progressBar.style.width = percent * 100 + "%";
                progressHandle.style.left = percent * 100 + "%";
            }

            progressContainer.addEventListener("click", seekToPosition);

            progressHandle.addEventListener("mousedown", function (e) {
                isDragging = true;
                e.preventDefault();
            });

            document.addEventListener("mousemove", function (e) {
                if (isDragging) {
                    var rect = progressContainer.getBoundingClientRect();
                    var percent = Math.max(
                        0,
                        Math.min(1, (e.clientX - rect.left) / rect.width),
                    );
                    progressBar.style.width = percent * 100 + "%";
                    progressHandle.style.left = percent * 100 + "%";
                    currentTimeEl.textContent = formatTime(
                        percent * audio.duration,
                    );
                }
            });

            document.addEventListener("mouseup", function (e) {
                if (isDragging) {
                    isDragging = false;
                    seekToPosition(e);
                }
            });

            function updatePlaybackPosition(positionMs) {
                // Find current place based on position
                var newPlaceIndex = -1;
                for (var i = placeTimings.length - 1; i >= 0; i--) {
                    if (positionMs >= placeTimings[i][0]) {
                        newPlaceIndex = i;
                        break;
                    }
                }

                // Update place if changed
                if (newPlaceIndex !== currentPlaceIndex && newPlaceIndex >= 0) {
                    currentPlaceIndex = newPlaceIndex;
                    var placeKey = placeTimings[newPlaceIndex][1];
                    var stanzaNum = placeTimings[newPlaceIndex][2];

                    // Show place on map (smooth animation)
                    showPlaceSmooth(placeKey);

                    // Update stanza highlighting
                    if (stanzaNum !== currentStanza) {
                        currentStanza = stanzaNum;
                        document
                            .querySelectorAll(".stanza")
                            .forEach(function (el) {
                                el.classList.remove("playing");
                                if (el.dataset.stanza == stanzaNum) {
                                    el.classList.add("playing");
                                    el.scrollIntoView({
                                        behavior: "smooth",
                                        block: "center",
                                    });
                                }
                            });
                    }
                }
            }

            function showPlaceSmooth(key) {
                var place = places[key];
                if (!place) return;

                // On mobile: update place bar (but don't auto-open bottom sheet during playback)
                // On desktop: update info panel
                if (isMobile()) {
                    updateMobilePlaceBar(place);
                } else {
                    document.getElementById("infoDefault").style.display =
                        "none";
                    document
                        .getElementById("placeInfo")
                        .classList.add("visible");
                    document.getElementById("placeName").textContent =
                        place.name;
                    document.getElementById("placeFragment").textContent =
                        "— " + place.fragment;
                    document.getElementById("placeDescription").textContent =
                        place.description;
                    document.getElementById("placeCoords").textContent =
                        place.coords[0].toFixed(2) +
                        "°S, " +
                        Math.abs(place.coords[1]).toFixed(2) +
                        "°W";
                    if (place.image) {
                        document.getElementById("placeImage").src = place.image;
                        document.getElementById("placeImage").alt = place.name;
                    }
                }

                // Update poem highlights
                document.querySelectorAll(".place-link").forEach(function (el) {
                    el.classList.remove("active");
                    if (el.dataset.place === key) {
                        el.classList.add("active");
                    }
                });

                // Smooth map animation
                if (map) {
                    map.flyTo(place.coords, 9, {
                        animate: true,
                        duration: 1.5,
                    });

                    // Update marker highlights
                    Object.keys(markers).forEach(function (k) {
                        var el = markers[k].getElement();
                        if (el) {
                            var dot = el.querySelector(".marker-dot");
                            if (dot) {
                                if (k === key) {
                                    dot.classList.add("active");
                                } else {
                                    dot.classList.remove("active");
                                }
                            }
                        }
                    });
                }
            }

            function initMap() {
                try {
                    map = L.map("map", {
                        center: [-37.5, -72.0],
                        zoom: 6,
                        zoomControl: true,
                    });

                    L.tileLayer(
                        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
                        {
                            attribution: "© OSM © CARTO",
                            subdomains: "abcd",
                            maxZoom: 12,
                        },
                    ).addTo(map);

                    // Markers only (no trajectory)
                    Object.keys(places).forEach(function (key) {
                        var place = places[key];
                        var isFinal = key === "rinihue";
                        var size = isFinal ? 18 : 14;

                        var bgColor = isFinal ? "#b8860b" : "#722f37";
                        var icon = L.divIcon({
                            className: "custom-marker-wrapper",
                            iconSize: [size, size],
                            iconAnchor: [size / 2, size / 2],
                            html:
                                '<div class="marker-dot' +
                                (isFinal ? " final" : "") +
                                '" style="width:' +
                                size +
                                "px;height:" +
                                size +
                                "px;background:" +
                                bgColor +
                                ';border:3px solid #f6f3ea;border-radius:50%;box-sizing:border-box;"></div>',
                        });

                        var marker = L.marker(place.coords, {
                            icon: icon,
                        }).addTo(map);
                        marker.on("click", function () {
                            showPlace(key);
                        });

                        // Add tooltip with place name
                        marker.bindTooltip(place.name, {
                            permanent: false,
                            direction: "top",
                            className: "place-tooltip",
                            offset: [0, -8],
                        });

                        markers[key] = marker;
                    });

                    // Fit bounds to all markers with tighter framing
                    var allCoords = Object.values(places).map(function (p) {
                        return p.coords;
                    });
                    var bounds = L.latLngBounds(allCoords);
                    map.fitBounds(bounds, { padding: [20, 20] });
                } catch (e) {
                    console.log("Map init failed:", e);
                    document.getElementById("map").innerHTML =
                        '<div style="padding: 40px; text-align: center; color: #5c4a3d; font-style: italic;">Mapa no disponible en este visor.<br><br>Descarga el archivo y ábrelo<br>en un navegador para ver el mapa.</div>';
                }
            }

            function isMobile() {
                return window.innerWidth <= 800;
            }

            // Store current place for expand button
            var currentMobilePlace = null;

            // Update mobile place bar (compact info below map)
            function updateMobilePlaceBar(place) {
                var nameEl = document.getElementById("mobileBarName");
                var fragmentEl = document.getElementById("mobileBarFragment");
                if (nameEl) nameEl.textContent = place.name;
                if (fragmentEl) fragmentEl.textContent = " — " + place.fragment;
                currentMobilePlace = place;
            }

            function showBottomSheet(place, placeKey) {
                document.getElementById("mobilePlaceName").textContent =
                    place.name;
                document.getElementById("mobilePlaceFragment").textContent =
                    "— " + place.fragment;
                document.getElementById("mobilePlaceDescription").textContent =
                    place.description;
                document.getElementById("mobilePlaceCoords").textContent =
                    place.coords[0].toFixed(2) +
                    "°S, " +
                    Math.abs(place.coords[1]).toFixed(2) +
                    "°W";

                // Set image from optimized URLs
                var imgEl = document.getElementById("bottomSheetImage");
                var imgContainer = document.getElementById(
                    "bottomSheetImageContainer",
                );
                var imageUrl =
                    window.placeImageUrls && window.placeImageUrls[placeKey];
                if (imageUrl && imgEl && imgContainer) {
                    imgEl.src = imageUrl;
                    imgEl.alt = place.name;
                    imgContainer.style.display = "block";
                } else if (imgContainer) {
                    imgContainer.style.display = "none";
                }

                document
                    .getElementById("bottomSheetOverlay")
                    .classList.add("visible");
                document.getElementById("bottomSheet").classList.add("visible");
            }

            function hideBottomSheet() {
                var sheet = document.getElementById("bottomSheet");
                sheet.classList.remove("visible", "expanded");
                document
                    .getElementById("bottomSheetOverlay")
                    .classList.remove("visible");
            }

            function toggleBottomSheetExpanded() {
                var sheet = document.getElementById("bottomSheet");
                sheet.classList.toggle("expanded");
            }

            // Bottom sheet swipe gesture handling
            (function () {
                var sheet = document.getElementById("bottomSheet");
                if (!sheet) return;

                var startY = 0;
                var currentY = 0;
                var isDragging = false;
                var startTransform = 0;

                sheet.addEventListener(
                    "touchstart",
                    function (e) {
                        // Only handle touches on the handle or when not scrolled
                        var handle = sheet.querySelector(
                            ".bottom-sheet-handle",
                        );
                        var isOnHandle = handle && handle.contains(e.target);
                        var isScrolledToTop = sheet.scrollTop === 0;
                        var isExpanded = sheet.classList.contains("expanded");

                        // Allow drag from handle always, or from content if at top
                        if (!isOnHandle && isExpanded && !isScrolledToTop)
                            return;

                        startY = e.touches[0].clientY;
                        isDragging = true;
                        startTransform = 0;
                        sheet.classList.add("dragging");
                    },
                    { passive: true },
                );

                sheet.addEventListener(
                    "touchmove",
                    function (e) {
                        if (!isDragging) return;

                        currentY = e.touches[0].clientY;
                        var deltaY = currentY - startY;

                        // Dragging down (positive deltaY) - allow freely
                        // Dragging up (negative deltaY) - only if not expanded
                        var isExpanded = sheet.classList.contains("expanded");

                        if (deltaY > 0) {
                            // Dragging down - apply transform with resistance
                            var resistance = 0.6;
                            sheet.style.transform =
                                "translateY(" + deltaY * resistance + "px)";
                        } else if (!isExpanded && deltaY < 0) {
                            // Dragging up when collapsed - visual feedback with resistance
                            var resistance = 0.3;
                            sheet.style.transform =
                                "translateY(" + deltaY * resistance + "px)";
                        }
                    },
                    { passive: true },
                );

                sheet.addEventListener(
                    "touchend",
                    function (e) {
                        if (!isDragging) return;
                        isDragging = false;
                        sheet.classList.remove("dragging");
                        sheet.style.transform = "";

                        var deltaY = currentY - startY;
                        var isExpanded = sheet.classList.contains("expanded");

                        // Threshold for action (50px)
                        var threshold = 50;

                        if (deltaY > threshold) {
                            // Swiped down
                            if (isExpanded) {
                                // Collapse
                                sheet.classList.remove("expanded");
                            } else {
                                // Close
                                hideBottomSheet();
                            }
                        } else if (deltaY < -threshold && !isExpanded) {
                            // Swiped up while collapsed - expand
                            sheet.classList.add("expanded");
                        }

                        startY = 0;
                        currentY = 0;
                    },
                    { passive: true },
                );
            })();

            function showPlace(key) {
                var place = places[key];
                if (!place) return;

                // On mobile: hide place bar (redundant with bottom sheet) and show bottom sheet
                if (isMobile()) {
                    var placeBar = document.getElementById("mobilePlaceBar");
                    if (placeBar) placeBar.style.display = "none";
                    showBottomSheet(place, key);
                } else {
                    // Update info panel (desktop)
                    document.getElementById("infoDefault").style.display =
                        "none";
                    document
                        .getElementById("placeInfo")
                        .classList.add("visible");
                    document.getElementById("placeName").textContent =
                        place.name;
                    document.getElementById("placeFragment").textContent =
                        "— " + place.fragment;
                    document.getElementById("placeDescription").textContent =
                        place.description;
                    document.getElementById("placeCoords").textContent =
                        place.coords[0].toFixed(2) +
                        "°S, " +
                        Math.abs(place.coords[1]).toFixed(2) +
                        "°W";
                    if (place.image) {
                        document.getElementById("placeImage").src = place.image;
                        document.getElementById("placeImage").alt = place.name;
                    }
                }

                // Update poem highlights
                document.querySelectorAll(".place-link").forEach(function (el) {
                    el.classList.remove("active");
                    if (el.dataset.place === key) {
                        el.classList.add("active");
                    }
                });

                // Update map
                if (map) {
                    map.setView(place.coords, 9, {
                        animate: true,
                        duration: 0.5,
                    });

                    Object.keys(markers).forEach(function (k) {
                        var el = markers[k].getElement();
                        if (el) {
                            var dot = el.querySelector(".marker-dot");
                            if (dot) {
                                if (k === key) {
                                    dot.classList.add("active");
                                } else {
                                    dot.classList.remove("active");
                                }
                            }
                        }
                    });
                }
            }

            // Event listeners
            document.querySelectorAll(".place-link").forEach(function (link) {
                link.addEventListener("click", function (e) {
                    e.preventDefault();
                    showPlace(this.dataset.place);
                });
            });

            // Bottom sheet event listeners
            document
                .getElementById("bottomSheetOverlay")
                .addEventListener("click", hideBottomSheet);

            // Tap handle to toggle expanded
            var sheetHandle = document.querySelector(
                "#bottomSheet .bottom-sheet-handle",
            );
            if (sheetHandle) {
                sheetHandle.addEventListener(
                    "click",
                    toggleBottomSheetExpanded,
                );
            }

            // Expose globals for the bundled script
            window.wordDefinitions = wordDefinitions;
            window.initMap = initMap;
        </script>

        <script>
            import L from "leaflet";
            import "leaflet/dist/leaflet.css";
            import tippy from "tippy.js";
            import "tippy.js/dist/tippy.css";

            // Expose Leaflet globally for inline script
            (window as any).L = L;

            // Wait for DOM and inline script to run
            document.addEventListener("DOMContentLoaded", () => {
                // Initialize map
                const initMap = (window as any).initMap;
                if (initMap) {
                    initMap();
                }

                // Initialize word definitions
                const wordDefinitions = (window as any).wordDefinitions;
                if (!wordDefinitions) return;

                const isMobile = () => window.innerWidth <= 800;

                // Mobile: use bottom sheet
                function showWordBottomSheet(def: any) {
                    const sheet = document.getElementById("wordBottomSheet");
                    const overlay = document.getElementById(
                        "wordBottomSheetOverlay",
                    );
                    if (!sheet || !overlay) return;

                    document.getElementById("wordSheetTitle")!.textContent =
                        def.word;
                    document.getElementById("wordSheetOrigin")!.textContent =
                        def.origin;
                    document.getElementById(
                        "wordSheetDefinition",
                    )!.textContent = def.definition;

                    const imgEl = document.getElementById(
                        "wordSheetImage",
                    ) as HTMLImageElement;
                    const imgContainer = document.getElementById(
                        "wordSheetImageContainer",
                    );
                    if (def.image && imgEl && imgContainer) {
                        imgEl.src = def.image;
                        imgEl.alt = def.word;
                        imgContainer.style.display = "block";
                    } else if (imgContainer) {
                        imgContainer.style.display = "none";
                    }

                    overlay.classList.add("visible");
                    sheet.classList.add("visible");
                }

                function hideWordBottomSheet() {
                    document
                        .getElementById("wordBottomSheetOverlay")
                        ?.classList.remove("visible");
                    document
                        .getElementById("wordBottomSheet")
                        ?.classList.remove("visible");
                }

                // Close word bottom sheet on overlay click
                document
                    .getElementById("wordBottomSheetOverlay")
                    ?.addEventListener("click", hideWordBottomSheet);

                // Info bottom sheet functions
                function showInfoBottomSheet() {
                    document
                        .getElementById("infoBottomSheetOverlay")
                        ?.classList.add("visible");
                    document
                        .getElementById("infoBottomSheet")
                        ?.classList.add("visible");
                }

                function hideInfoBottomSheet() {
                    document
                        .getElementById("infoBottomSheetOverlay")
                        ?.classList.remove("visible");
                    document
                        .getElementById("infoBottomSheet")
                        ?.classList.remove("visible");
                }

                // Close info bottom sheet on overlay click
                document
                    .getElementById("infoBottomSheetOverlay")
                    ?.addEventListener("click", hideInfoBottomSheet);

                // Info icon: show bottom sheet on mobile, tooltip on desktop
                const infoIcon = document.querySelector(".poem-header .info-icon");
                if (infoIcon) {
                    infoIcon.addEventListener("click", (e) => {
                        if (isMobile()) {
                            e.preventDefault();
                            e.stopPropagation();
                            showInfoBottomSheet();
                        }
                    });
                }

                document
                    .querySelectorAll(".word-hint")
                    .forEach((hint: Element) => {
                        const wordKey = (hint as HTMLElement).dataset.word;
                        if (!wordKey) return;
                        const def = wordDefinitions[wordKey];
                        if (!def) return;

                        // Desktop: tippy tooltip with inline styles for reliability
                        const cardStyle = def.image
                            ? "display:flex;flex-direction:row;align-items:flex-start;gap:14px;padding:14px;"
                            : "padding:14px;";
                        const imgStyle =
                            "width:80px;height:80px;min-width:80px;object-fit:cover;border-radius:4px;flex-shrink:0;";
                        const textStyle = "flex:1;min-width:0;";
                        const headerStyle =
                            "display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;margin-bottom:8px;";
                        const titleStyle =
                            "font-family:Cormorant Garamond,Georgia,serif;font-weight:600;font-size:1.15rem;";
                        const originStyle =
                            "font-style:italic;font-size:0.9rem;color:#b8860b;";
                        const defStyle =
                            "font-size:0.95rem;line-height:1.5;color:rgba(246,243,234,0.95);";

                        let html = `<div style="${cardStyle}">`;
                        if (def.image) {
                            html += `<img style="${imgStyle}" src="${def.image}" alt="${def.word}" />`;
                        }
                        html += `<div style="${textStyle}">`;
                        html += `<div style="${headerStyle}"><span style="${titleStyle}">${def.word}</span> <span style="${originStyle}">${def.origin}</span></div>`;
                        html += `<div style="${defStyle}">${def.definition}</div>`;
                        html += "</div></div>";

                        tippy(hint as HTMLElement, {
                            content: html,
                            allowHTML: true,
                            placement: "top",
                            theme: "word-definition",
                            maxWidth: def.image ? 380 : 300,
                            interactive: true,
                            appendTo: document.body,
                            touch: false,
                        });

                        // Mobile: tap to show bottom sheet
                        hint.addEventListener("click", (e) => {
                            if (isMobile()) {
                                e.preventDefault();
                                e.stopPropagation();
                                showWordBottomSheet(def);
                            }
                        });
                    });
            });
        </script>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --parchment: #f6f3ea;
                --parchment-dark: #ebe7dc;
                --ink: #2c2416;
                --ink-light: #4a3f2f;
                --rust: #8b4513;
                --earth: #5c4a3d;
                --blood: #722f37;
                --gold: #b8860b;
                --sea: #d4dfe3;
            }

            html {
                scroll-behavior: smooth;
            }

            body {
                font-family: "Cormorant Garamond", Georgia, serif;
                background: var(--parchment);
                color: var(--ink);
                line-height: 1.6;
                height: 100vh;
                overflow: hidden;
            }

            /* Desktop layout: 2-column grid */
            .main-container {
                display: grid;
                grid-template-columns: 340px 1fr;
                grid-template-rows: auto auto 1fr;
                height: 100vh;
            }

            /* Desktop: sticky-header uses display: contents so children participate in grid */
            .sticky-header {
                display: contents;
            }

            /* Desktop grid positioning */
            .poem-header {
                grid-column: 1;
                grid-row: 1;
            }

            .audio-player-row {
                grid-column: 2;
                grid-row: 1;
            }

            .sidebar-info {
                grid-column: 2;
                grid-row: 2;
                background: var(--parchment-dark);
                border-bottom: 1px solid rgba(44, 36, 22, 0.15);
                overflow-y: auto;
            }

            .map-panel {
                grid-column: 2;
                grid-row: 3;
            }

            .poem-main {
                grid-column: 1;
                grid-row: 2 / 4;
                background: var(--parchment);
                border-right: 1px solid rgba(44, 36, 22, 0.15);
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            /* Desktop: hide mobile-only elements */
            .mobile-place-bar {
                display: none;
            }

            .poem-header {
                padding: 1.25rem 1.25rem 1rem;
                border-bottom: 1px solid rgba(44, 36, 22, 0.12);
                background: linear-gradient(
                    to bottom,
                    var(--parchment),
                    var(--parchment-dark)
                );
            }

            .poem-header h1 {
                font-size: 1.4rem;
                font-weight: 400;
                letter-spacing: 0.06em;
                margin-bottom: 0.1rem;
            }

            .poem-header .subtitle {
                font-size: 0.95rem;
                color: var(--earth);
                font-style: italic;
                display: inline;
            }

            .poem-header .year {
                font-size: 0.85rem;
                color: var(--earth);
                opacity: 0.7;
                margin-left: 0.3rem;
            }

            .poem-header .info-icon {
                display: inline-block;
                width: 16px;
                height: 16px;
                line-height: 16px;
                text-align: center;
                font-size: 0.7rem;
                color: var(--earth);
                border: 1px solid var(--earth);
                border-radius: 50%;
                margin-left: 0.4rem;
                cursor: help;
                position: relative;
                vertical-align: middle;
                opacity: 0.6;
                transition: opacity 0.2s;
            }

            .poem-header .info-icon:hover {
                opacity: 1;
            }

            .poem-header .info-icon:hover .tooltip {
                opacity: 1;
                visibility: visible;
            }

            .poem-header .tooltip {
                position: absolute;
                left: 50%;
                top: 100%;
                transform: translateX(-50%);
                margin-top: 8px;
                background: var(--ink);
                color: var(--parchment);
                padding: 0.6rem 0.8rem;
                border-radius: 3px;
                font-size: 0.78rem;
                font-style: normal;
                line-height: 1.4;
                width: 220px;
                text-align: left;
                opacity: 0;
                visibility: hidden;
                transition: all 0.2s;
                z-index: 100;
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            }

            .poem-header .tooltip::before {
                content: "";
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                border: 6px solid transparent;
                border-bottom-color: var(--ink);
            }

            .poem-content {
                flex: 1;
                padding: 1.25rem 1.25rem 1.25rem 2.5rem;
                overflow-y: auto;
            }

            .stanza {
                margin-bottom: 1.25rem;
                padding: 0.8rem 0.5rem 0.8rem 1.8rem;
                position: relative;
                border-left: 2px solid rgba(139, 69, 19, 0.15);
                transition: all 0.3s ease;
                border-radius: 0 4px 4px 0;
            }

            .stanza:hover {
                border-left-color: rgba(139, 69, 19, 0.35);
            }

            .stanza.playing {
                border-left-color: var(--gold);
                border-left-width: 3px;
            }

            .stanza.playing .stanza-number {
                background: var(--gold);
            }

            .stanza:last-child {
                margin-bottom: 0.5rem;
            }

            .stanza-number {
                position: absolute;
                left: -3rem;
                top: 0.8rem;
                font-size: 0.8rem;
                color: var(--parchment);
                background: var(--rust);
                width: 1.6rem;
                height: 1.6rem;
                line-height: 1.6rem;
                text-align: center;
                border-radius: 50%;
                font-style: normal;
                transition: all 0.3s ease;
            }

            .verse-line {
                font-size: 1.05rem;
                line-height: 1.7;
            }

            .place-link {
                color: var(--blood);
                text-decoration: none;
                border-bottom: 1px dotted var(--blood);
                cursor: pointer;
                transition: all 0.2s;
            }

            .place-link:hover {
                color: var(--gold);
                border-bottom-color: var(--gold);
            }

            .place-link.active {
                color: var(--gold);
                border-bottom: 2px solid var(--gold);
                font-weight: 500;
            }

            /* Word hints */
            .word-hint {
                color: inherit;
                border-bottom: 1px dotted var(--earth);
                cursor: help;
                transition:
                    color 0.2s,
                    border-bottom-color 0.2s;
            }

            .word-hint:hover {
                color: var(--gold);
                border-bottom-color: var(--gold);
            }

            /* Tippy.js theme for word definitions */
            .tippy-box[data-theme~="word-definition"] {
                background-color: var(--ink);
                color: var(--parchment);
                border-radius: 6px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                font-family: "Source Serif 4", Georgia, serif;
            }

            .tippy-box[data-theme~="word-definition"] > .tippy-arrow::before {
                border-top-color: var(--ink);
            }

            .tippy-box[data-theme~="word-definition"][data-placement^="bottom"]
                > .tippy-arrow::before {
                border-bottom-color: var(--ink);
            }

            .tippy-box[data-theme~="word-definition"] > .tippy-content {
                padding: 0;
            }

            /* Card layout for tooltips */
            .word-tooltip-card {
                display: flex !important;
                flex-direction: row !important;
                align-items: flex-start;
                gap: 0.75rem;
                padding: 0.75rem;
            }

            .word-tooltip-card .word-tooltip-image {
                width: 70px !important;
                height: 70px !important;
                min-width: 70px;
                max-width: 70px;
                min-height: 70px;
                max-height: 70px;
                object-fit: cover;
                border-radius: 4px;
                flex-shrink: 0;
                display: block;
            }

            .word-tooltip-card .word-tooltip-text {
                flex: 1;
                min-width: 0;
            }

            .word-tooltip-header {
                display: flex;
                align-items: baseline;
                gap: 0.4rem;
                flex-wrap: wrap;
                margin-bottom: 0.35rem;
            }

            .word-tooltip-title {
                font-family: "Cormorant Garamond", Georgia, serif;
                font-weight: 600;
                font-size: 1rem;
            }

            .word-tooltip-origin {
                font-style: italic;
                font-size: 0.75rem;
                color: var(--gold);
            }

            .word-tooltip-definition {
                font-size: 0.78rem;
                line-height: 1.45;
                color: rgba(246, 243, 234, 0.9);
            }

            .poem-footer {
                padding: 0.75rem 1.25rem;
                border-top: 1px solid rgba(44, 36, 22, 0.1);
                font-size: 0.75rem;
                color: var(--earth);
                background: var(--parchment-dark);
            }

            .poem-footer a {
                color: var(--blood);
            }

            /* Custom Audio Player */
            .audio-player-row {
                padding: 0.75rem 1rem;
                background: linear-gradient(
                    135deg,
                    rgba(114, 47, 55, 0.08) 0%,
                    rgba(184, 134, 11, 0.05) 100%
                );
                border-bottom: 1px solid rgba(44, 36, 22, 0.12);
            }

            .audio-player {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.6rem 0.8rem;
                background: var(--parchment);
                border-radius: 8px;
                box-shadow:
                    0 1px 3px rgba(44, 36, 22, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5);
                border: 1px solid rgba(44, 36, 22, 0.1);
            }

            .audio-player audio {
                display: none;
            }

            .play-btn {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: 2px solid var(--blood);
                background: var(--parchment);
                color: var(--blood);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                flex-shrink: 0;
                position: relative;
            }

            .play-btn:hover {
                background: var(--blood);
                color: var(--parchment);
                transform: scale(1.05);
            }

            .play-btn:active {
                transform: scale(0.98);
            }

            .play-btn .play-icon {
                font-size: 0.7rem;
                margin-left: 2px;
            }

            .play-btn .pause-icon {
                display: none;
                font-size: 0.65rem;
                letter-spacing: 1px;
            }

            .audio-player.playing .play-btn .play-icon {
                display: none;
            }

            .audio-player.playing .play-btn .pause-icon {
                display: block;
            }

            .audio-player.playing .play-btn {
                background: var(--blood);
                color: var(--parchment);
                animation: pulse 2s ease-in-out infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    box-shadow: 0 0 0 0 rgba(114, 47, 55, 0.4);
                }
                50% {
                    box-shadow: 0 0 0 6px rgba(114, 47, 55, 0);
                }
            }

            .player-info {
                flex-shrink: 0;
                min-width: 0;
            }

            .track-title {
                font-family: "Cormorant Garamond", Georgia, serif;
                font-size: 0.9rem;
                font-weight: 600;
                color: var(--ink);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .track-artist {
                font-family: "Source Serif 4", Georgia, serif;
                font-size: 0.72rem;
                color: var(--earth);
                white-space: nowrap;
            }

            .progress-container {
                flex: 1;
                height: 6px;
                background: rgba(44, 36, 22, 0.1);
                border-radius: 3px;
                cursor: pointer;
                position: relative;
                margin: 0 0.25rem;
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(
                    90deg,
                    var(--blood) 0%,
                    var(--gold) 100%
                );
                border-radius: 3px;
                width: 0%;
                transition: width 0.1s linear;
            }

            .progress-handle {
                position: absolute;
                top: 50%;
                left: 0%;
                transform: translate(-50%, -50%);
                width: 14px;
                height: 14px;
                background: var(--parchment);
                border: 2px solid var(--blood);
                border-radius: 50%;
                cursor: grab;
                opacity: 0;
                transition:
                    opacity 0.2s,
                    transform 0.1s;
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            }

            .audio-player:hover .progress-handle,
            .progress-handle:active {
                opacity: 1;
            }

            .progress-handle:active {
                cursor: grabbing;
                transform: translate(-50%, -50%) scale(1.2);
            }

            .time-display {
                font-family: "Source Serif 4", Georgia, serif;
                font-size: 0.72rem;
                color: var(--earth);
                white-space: nowrap;
                flex-shrink: 0;
                min-width: 70px;
                text-align: right;
            }

            .time-separator {
                opacity: 0.5;
                margin: 0 2px;
            }

            .place-info-content {
                flex: 1;
                padding: 1rem 1.25rem;
                overflow-y: auto;
            }

            .info-default {
                color: var(--earth);
                font-style: italic;
                text-align: center;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .info-default p {
                font-size: 0.95rem;
                line-height: 1.5;
            }

            .place-info {
                display: none;
            }

            .place-info.visible {
                display: flex;
                gap: 1rem;
                align-items: flex-start;
            }

            .place-info .place-image-container {
                flex-shrink: 0;
                width: 120px;
                height: 120px;
                overflow: hidden;
                border-radius: 4px;
                background: var(--parchment-dark);
            }

            .place-info .place-image-container img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .place-info .place-text {
                flex: 1;
                min-width: 0;
            }

            .place-info .place-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 0.5rem;
            }

            .place-info .place-title-row {
                display: flex;
                align-items: baseline;
                gap: 0.4rem;
                flex-wrap: wrap;
            }

            .place-info h3 {
                font-size: 1.15rem;
                font-weight: 500;
                margin: 0;
                color: var(--ink);
            }

            .place-info .fragment {
                font-style: italic;
                color: var(--blood);
                font-size: 0.85rem;
            }

            .place-info .coords {
                font-size: 0.7rem;
                color: var(--earth);
                opacity: 0.7;
                white-space: nowrap;
                margin-left: 0.5rem;
            }

            .place-info .description {
                font-size: 0.85rem;
                color: var(--ink-light);
                line-height: 1.5;
                font-family: "Source Serif 4", Georgia, serif;
            }

            /* Map (bottom 2/3) */
            .map-panel {
                flex: 1;
                position: relative;
            }

            #map {
                height: 100%;
                width: 100%;
                background: var(--sea);
            }

            /* Leaflet customizations */
            .leaflet-container {
                background: var(--sea);
                font-family: "Cormorant Garamond", Georgia, serif;
            }

            :global(.custom-marker-wrapper) {
                background: transparent !important;
                border: none !important;
            }

            :global(.marker-dot) {
                box-shadow:
                    0 2px 8px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(114, 47, 55, 0.3);
                transition: all 0.2s ease;
            }

            :global(.marker-dot:hover) {
                transform: scale(1.2);
                box-shadow:
                    0 3px 12px rgba(0, 0, 0, 0.5),
                    0 0 0 2px rgba(114, 47, 55, 0.4);
            }

            :global(.marker-dot.active) {
                background: #b8860b !important;
                border-color: #fff !important;
                transform: scale(1.4);
                box-shadow:
                    0 4px 16px rgba(184, 134, 11, 0.6),
                    0 0 0 2px rgba(184, 134, 11, 0.3);
            }

            :global(.marker-dot.final) {
                box-shadow:
                    0 2px 8px rgba(184, 134, 11, 0.5),
                    0 0 0 1px rgba(184, 134, 11, 0.3);
            }

            :global(.place-tooltip) {
                background: #2c2416;
                color: #f6f3ea;
                border: none;
                border-radius: 3px;
                font-family: "Cormorant Garamond", Georgia, serif;
                font-size: 0.85rem;
                padding: 4px 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            :global(.place-tooltip::before) {
                border-top-color: #2c2416;
            }

            .leaflet-popup-content-wrapper {
                background: var(--parchment);
                border-radius: 2px;
                box-shadow: 0 3px 14px rgba(0, 0, 0, 0.2);
            }

            .leaflet-popup-content {
                font-family: "Cormorant Garamond", Georgia, serif;
                margin: 10px 14px;
                font-size: 0.95rem;
            }

            .leaflet-popup-tip {
                background: var(--parchment);
            }

            /* Responsive - Mobile */
            @media (max-width: 800px) {
                body {
                    overflow-x: hidden;
                    overflow-y: auto;
                    height: auto;
                }

                .main-container {
                    display: flex;
                    flex-direction: column;
                    min-height: 100vh;
                }

                /* SINGLE STICKY WRAPPER: no hardcoded heights */
                .sticky-header {
                    display: flex;
                    flex-direction: column;
                    position: sticky;
                    top: 0;
                    z-index: 100;
                    background: var(--parchment);
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                }

                .sticky-header > * {
                    flex-shrink: 0;
                }

                .poem-header {
                    grid-column: unset;
                    grid-row: unset;
                    padding: 0.75rem 1rem;
                    border-bottom: 1px solid rgba(44, 36, 22, 0.12);
                    background: linear-gradient(
                        to bottom,
                        var(--parchment),
                        var(--parchment-dark)
                    );
                }

                .poem-header h1 {
                    font-size: 1.2rem;
                    line-height: 1.2;
                }

                /* Hide tooltip on mobile, use bottom sheet instead */
                .poem-header .info-icon .tooltip {
                    display: none;
                }

                .poem-header .info-icon {
                    cursor: pointer;
                    opacity: 0.8;
                }

                .audio-player-row {
                    grid-column: unset;
                    grid-row: unset;
                    border-bottom: none;
                    background: var(--parchment);
                }

                .map-panel {
                    grid-column: unset;
                    grid-row: unset;
                    height: 180px;
                    min-height: 180px;
                    width: 100%;
                }

                .map-panel #map {
                    height: 180px;
                    min-height: 180px;
                    width: 100%;
                }

                /* Mobile place bar - compact info below map */
                .mobile-place-bar {
                    display: flex;
                    align-items: center;
                    padding: 0 1rem;
                    min-height: 36px;
                    background: var(--parchment-dark);
                    border-bottom: 1px solid rgba(44, 36, 22, 0.15);
                }

                .mobile-place-bar .place-summary {
                    font-size: 0.9rem;
                    color: var(--ink);
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    flex: 1;
                    min-width: 0;
                }

                .mobile-place-bar .place-summary .place-name {
                    font-weight: 500;
                }

                .mobile-place-bar .place-summary .fragment {
                    color: var(--blood);
                    font-style: italic;
                    margin-left: 0.25rem;
                }

                /* Hide sidebar on mobile (we use bottom sheet instead) */
                .sidebar-info {
                    display: none;
                }

                .poem-main {
                    grid-column: unset;
                    grid-row: unset;
                    flex: 1;
                    border-right: none;
                }

                .poem-content {
                    padding: 1rem 1rem 1rem 2.2rem;
                    overflow: visible;
                }

                /* Stanza numbers más pequeños */
                .stanza-number {
                    width: 1.4rem;
                    height: 1.4rem;
                    line-height: 1.4rem;
                    font-size: 0.7rem;
                    left: -1.7rem;
                }

                .stanza {
                    padding-left: 1.5rem;
                }

                /* Audio player compacto */
                .audio-player {
                    gap: 0.5rem;
                    padding: 0.5rem 0.6rem;
                }

                .player-info {
                    display: none; /* Ocultar título/artista en mobile pequeño */
                }

                .play-btn {
                    width: 44px;
                    height: 44px; /* Touch target mínimo recomendado */
                }

                .progress-container {
                    height: 8px; /* Más fácil de tocar */
                }

                .progress-handle {
                    width: 18px;
                    height: 18px;
                    opacity: 1; /* Siempre visible en mobile */
                }
            }

            /* Bottom Sheet - solo mobile */
            @media (max-width: 800px) {
                /* Overlay covers entire screen, but sticky header has higher z-index */
                .bottom-sheet-overlay {
                    display: block;
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.3);
                    opacity: 0;
                    visibility: hidden;
                    transition:
                        opacity 0.3s,
                        visibility 0.3s;
                    z-index: 99; /* Lower than sticky-header (100) */
                }

                .bottom-sheet-overlay.visible {
                    opacity: 1;
                    visibility: visible;
                }

                .bottom-sheet {
                    display: block;
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: var(--parchment);
                    border-radius: 16px 16px 0 0;
                    padding: 0.5rem 1.25rem 1.5rem;
                    transform: translateY(100%);
                    transition:
                        transform 0.3s ease-out,
                        max-height 0.3s ease-out;
                    z-index: 1000;
                    /* Collapsed state: show title + description preview */
                    max-height: 35vh;
                    overflow: hidden;
                    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
                    touch-action: none; /* We handle touch ourselves */
                }

                .bottom-sheet.visible {
                    transform: translateY(0);
                }

                /* Expanded state: show full content + image */
                .bottom-sheet.expanded {
                    max-height: 75vh;
                    overflow-y: auto;
                }

                /* Dragging state: disable transitions for responsive feel */
                .bottom-sheet.dragging {
                    transition: none;
                }

                .bottom-sheet .bottom-sheet-handle {
                    width: 40px;
                    height: 5px;
                    background: rgba(44, 36, 22, 0.25);
                    border-radius: 3px;
                    margin: 0 auto 0.75rem;
                    cursor: grab;
                }

                .bottom-sheet .bottom-sheet-handle:active {
                    cursor: grabbing;
                }

                /* Image: hidden in collapsed, visible in expanded */
                .bottom-sheet .bottom-sheet-image-container {
                    width: 100%;
                    margin-top: 0.75rem;
                    border-radius: 8px;
                    overflow: hidden;
                    background: var(--parchment-dark);
                    opacity: 0;
                    max-height: 0;
                    transition:
                        max-height 0.3s ease-out,
                        opacity 0.3s ease-out;
                }

                .bottom-sheet.expanded .bottom-sheet-image-container {
                    /* Allow up to 1:1 aspect ratio */
                    max-height: calc(100vw - 2.5rem);
                    opacity: 1;
                }

                .bottom-sheet .bottom-sheet-image-container img {
                    width: 100%;
                    height: auto;
                    max-height: calc(100vw - 2.5rem); /* Cap at ~1:1 */
                    object-fit: cover;
                }

                .bottom-sheet .bottom-sheet-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    gap: 0.5rem;
                    margin-bottom: 0.5rem;
                }

                .bottom-sheet .place-title-row {
                    display: flex;
                    align-items: baseline;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                    flex: 1;
                    min-width: 0;
                }

                .bottom-sheet h3 {
                    font-size: 1.1rem;
                    font-weight: 500;
                    color: var(--ink);
                    margin: 0;
                }

                .bottom-sheet .fragment {
                    font-style: italic;
                    color: var(--blood);
                    font-size: 0.85rem;
                }

                .bottom-sheet .coords {
                    font-size: 0.7rem;
                    color: var(--earth);
                    opacity: 0.7;
                    white-space: nowrap;
                    flex-shrink: 0;
                    padding-top: 0.2rem; /* Align with title baseline */
                }

                .bottom-sheet .description {
                    font-size: 0.9rem;
                    color: var(--ink-light);
                    line-height: 1.6;
                    font-family: "Source Serif 4", Georgia, serif;
                }

                /* Word definition bottom sheet */
                .word-bottom-sheet {
                    max-height: 50vh;
                }

                .word-sheet-content {
                    display: flex;
                    gap: 1rem;
                    align-items: flex-start;
                }

                .word-sheet-image-container {
                    flex-shrink: 0;
                }

                .word-sheet-image-container img {
                    width: 90px;
                    height: 90px;
                    object-fit: cover;
                    border-radius: 6px;
                }

                .word-sheet-text {
                    flex: 1;
                    min-width: 0;
                }

                .word-sheet-header {
                    display: flex;
                    align-items: baseline;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                    margin-bottom: 0.5rem;
                }

                .word-sheet-title {
                    font-family: "Cormorant Garamond", Georgia, serif;
                    font-size: 1.2rem;
                    font-weight: 600;
                    color: var(--ink);
                }

                .word-sheet-origin {
                    font-style: italic;
                    font-size: 0.85rem;
                    color: var(--gold);
                }

                .word-sheet-definition {
                    font-size: 0.95rem;
                    color: var(--ink-light);
                    line-height: 1.5;
                    font-family: "Source Serif 4", Georgia, serif;
                }

                /* Info bottom sheet */
                .info-bottom-sheet {
                    max-height: 40vh;
                }

                .info-sheet-header h3 {
                    font-size: 1.1rem;
                    font-weight: 500;
                    color: var(--ink);
                    margin: 0 0 0.75rem 0;
                }

                .info-sheet-content {
                    font-size: 0.95rem;
                    color: var(--ink-light);
                    line-height: 1.6;
                    font-family: "Source Serif 4", Georgia, serif;
                }

                .info-sheet-content em {
                    color: var(--ink);
                }
            }

            /* Desktop: ocultar bottom sheet */
            @media (min-width: 801px) {
                .bottom-sheet-overlay,
                .bottom-sheet {
                    display: none;
                }
            }

            /* Teléfonos pequeños */
            @media (max-width: 380px) {
                .poem-header h1 {
                    font-size: 1.1rem;
                }

                .verse-line {
                    font-size: 0.95rem;
                }

                .time-display {
                    font-size: 0.65rem;
                    min-width: 60px;
                }

                .stanza {
                    padding: 0.6rem 0.4rem 0.6rem 1.3rem;
                }

                .stanza-number {
                    width: 1.2rem;
                    height: 1.2rem;
                    line-height: 1.2rem;
                    font-size: 0.65rem;
                    left: -1.4rem;
                }
            }
        </style>
    </body>
</html>
